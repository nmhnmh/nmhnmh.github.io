<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />
<!-- Facebook OG Tags-->
<meta property="og:type" content="website">
<meta property="og:url" content="http://niminghao.com/post/raspberry-pi-with-bluetooth-speaker">
<meta property="og:title" content="树莓派连接蓝牙音箱或者耳机">
<meta property="og:description" content="">
<meta property="og:site_name" content="明浩的个人网站">
<meta property="og:locale" content="en_US">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@niminghao">
<meta name="twitter:creator" content="@niminghao">
<meta name="twitter:url" content="http://niminghao.com/post/raspberry-pi-with-bluetooth-speaker">
<meta name="twitter:title" content="树莓派连接蓝牙音箱或者耳机">
<meta name="twitter:description" content="">

<title>Post: 树莓派连接蓝牙音箱或者耳机</title>
    <link rel="stylesheet" href="/assets/css/normalize.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/9.11.0/styles/monokai-sublime.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/desktop.css">
    <link rel="stylesheet" href="/assets/css/mobile.css">
  </head>
  <body>
    <header>
      <a href="/" id="logo">明浩的个人网站</a>
      <div id="nav_trigger">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <ul id="nav_menu">
        <li><a href="/posts">写 / Posts</a></li>
        <li><a href="/books">读 / Reading</a></li>
        <li><a href="/projects">做 / Projects</a></li>
        <li><a href="/references">杂 / References</a></li>
        <li><a href="/about">我 / About</a></li>
        <li><input type="text" id="q" placeholder="搜 / Search"></li>
      </ul>
      <div id="q_results">
      </div>
    </header>
    <div class="wrapper">
  <div class="" id="entry_header">
    <span class="entry_title">树莓派连接蓝牙音箱或者耳机</span>
    <div class="entry_info">
      Feb 26, 2018
    </div>
  </div>

  <div class="content_wrapper">
    <p>树莓派本身带有两个音频输出方案：hdmi数字音频输出(可以配合支持hdmi音频的显示器或者转接口使用)和3.5mm耳机接口。现在各种蓝牙耳机和音箱也越来越多，大多数智能音箱也支持蓝牙连接，将树莓派与这些无线音频输出设备进行连接变得流行起来了。本文简单介绍两种方法将蓝牙音箱与树莓派连接的方法。</p>
<p>本文中使用的树莓派版本是 Pi3 Model B V1.2，系统版本是：Raspbian GNU/Linux 9.3 (stretch)。本文使用是Raspbian的lite版本，默认没有图形界面以及多数非必要的软件包。带有图形界面的Raspbian蓝牙应该是可以开箱即用的，无需特殊设置。使用的蓝牙音箱是天猫精灵。</p>
<p>在进行正式的配置之前，有必要简单介绍一下各个软件包的作用和原理。<a href="https://en.wikipedia.org/wiki/Advanced_Linux_Sound_Architecture">ALSA(Advanced Linux Sound Architechture)</a>是Linux上的主流音频框架，是linux内核的一部分，这是最底层的音频接口，一般只有声卡驱动厂商需要与其对接，普通用户不需要了解这一部分，只要使用即可。后面使用的<code>aplay</code>命令就是ALSA相关的包提供的。<a href="http://www.bluez.org/">Bluez</a>是一个蓝牙协议栈实现，简单说就是linux上所有蓝牙相关的底层功能都是由它提供的，没有他蓝牙就无法工作，Bluez主要提供蓝牙基础设施、和最基本的蓝牙管理工具，后面用到的<code>bluetoothctl</code>命令就是Bluez里面提供的，桌面环境下的各种蓝牙图形界面通常是由其它的软件包提供。<a href="https://www.freedesktop.org/wiki/Software/PulseAudio/">PulseAudio</a>是一个sound server，是目前linux环境下的一个主流高级音频解决方案，与ALSA不同的是，PulseAudio不与底层声卡直接打交道（这是ALSA的工作），他介于音频播放软件(如omxplayer, mplayer等)和ALSA之间，他的功能主要集中在与各种音频播放软件对接、多路音频混合、音频转发（到不同的声卡或者网卡）等，有了它我们就能轻松实现给不同的音频源设置不同的音量，音频流媒体等高级功能。后面使用的<code>pulseaudio</code>、<code>pactl</code>、<code>pacmd</code>等命令都是PulseAudio提供的。</p>
<p>在进行音频播放前，需要通过<code>bluetoothctl</code>命令搜索到目标蓝牙音频设备，并与其进行配对连接。</p>
<h1>连接方案1：Bluez + ALSA</h1>
<p>这是一种非常轻量级的方案，需要的安装包数量最少，能满足基本的蓝牙音频播放，但是不建议日常使用。Bluez是linux平台的标准蓝牙协议栈，默认系统已经安装了。ALSA也是Linux下的标准音频输出解决方案，内置于Linux内核之中。按照道理来讲，有了这两者，我们就可以实现蓝牙音频播放了。在Bluez 5之前，我们确实可以直接做到，但是由于Bluez 5之后，取消了直接进行音频输出的支持，所以我们需要一个额外的软件包来将Bluez和ALSA连接起来实现播放。这个软件包就是<a href="https://github.com/Arkq/bluez-alsa">bluez-alsa</a>。具体命令如下：</p>
<pre><code class="sh">// 下载一个测试音频文件
wget -O example.wav http://www.music.helsinki.fi/tmt/opetus/uusmedia/esim/a2002011001-e02-ulaw.wav
// 安装bluezalsa软件包
sudo apt-get install bluealsa
// 播放音频文件，将DEV=后面的地址改为你的蓝牙音箱的实际MAC地址
aplay -D bluealsa:HCI=hci0,DEV=XX:XX:XX:XX:XX:XX,PROFILE=a2dp example.wav
</code></pre>

<p>可以通过设置<code>~/.asoundrc</code>文件来避免每次播放都需要指定输出设备(其中的device地址需要改成蓝牙音箱真实mac地址)：</p>
<pre><code class="sh">$ cat ~/.asoundrc
defaults.bluealsa.interface &quot;hci0&quot;
defaults.bluealsa.device &quot;XX:XX:XX:XX:XX:XX&quot;
defaults.bluealsa.profile &quot;a2dp&quot;
defaults.bluealsa.delay 10000
</code></pre>

<h1>连接方案2：Bluez + PulseAudio</h1>
<p>PulseAudio是目前Linux中非常主流的一个音频播放方案，功能完善，被主流的linux发行版所采用。这也是桌面版Raspbian所采用的方案。PulseAudio作为一个Sound Server处于音频播放软件和系统底层音频接口之间，可以实现软件混音、音频转发等各种高级功能。PulseAudio能够识别蓝牙音频设备，并将音频输出导入到其中进行播放。由于Raspbian Lite版本没有默认安装PulseAudio，我们需要手动进行安装：</p>
<pre><code class="sh">sudo apt-get install pulseaudio
sudo apt-get install pulseaudio-module-bluetooth
</code></pre>

<p>在PulseAudio安装完成后，进行蓝牙连接后，蓝牙音箱会被PulseAudio识别为一个音频输出通道（audio sink)。可以通过以下命令查看确认蓝牙音箱已经被识别：</p>
<pre><code>$ pactl list sinks
Sink #1
    State: SUSPENDED
    Name: bluez_sink.AB_12_34_56_78_90.a2dp_sink
    Description: Tmall Genie
    Driver: module-bluez5-device.c
    Sample Specification: s16le 2ch 44100Hz
    Channel Map: front-left,front-right
    Owner Module: 23
    Mute: no
    Volume: front-left: 65536 / 100% / 0.00 dB,   front-right: 65536 / 100% / 0.00 dB
            balance 0.00
    Base Volume: 65536 / 100% / 0.00 dB
    Monitor Source: bluez_sink.AB_12_34_56_78_90.a2dp_sink.monitor
    Latency: 0 usec, configured 0 usec
    Flags: HARDWARE DECIBEL_VOLUME LATENCY
    Properties:
        bluetooth.protocol = &quot;a2dp_sink&quot;
        device.description = &quot;Tmall Genie&quot;
        device.string = &quot;AB:12:34:56:78:90&quot;
        device.api = &quot;bluez&quot;
        device.class = &quot;sound&quot;
        device.bus = &quot;bluetooth&quot;
        device.form_factor = &quot;speaker&quot;
        bluez.path = &quot;/org/bluez/hci0/dev_AB_12_34_56_78_90&quot;
        bluez.class = &quot;0x2c0414&quot;
        bluez.alias = &quot;我的Tmall Genie&quot;
        device.icon_name = &quot;audio-speakers-bluetooth&quot;
    Ports:
        speaker-output: Speaker (priority: 0)
    Active Port: speaker-output
    Formats:
        pcm
</code></pre>

<p>此时，蓝牙音频设备已经被识别，但是可能并不是默认的音频输出设备，我们可以手动将其设为默认输出设备：</p>
<pre><code>$ pactl set-default-sink bluez_sink.AB_12_34_56_78_90.a2dp_sink
$ pactl info
Server String: /run/user/1000/pulse/native
Library Protocol Version: 32
Server Protocol Version: 32
Is Local: yes
Client Index: 47
Tile Size: 65496
User Name: pi
Host Name: raspberrypi
Server Name: pulseaudio
Server Version: 10.0
Default Sample Specification: s16le 2ch 44100Hz
Default Channel Map: front-left,front-right
Default Sink: bluez_sink.AB_12_34_56_78_90.a2dp_sink
Default Source: alsa_output.platform-soc_audio.analog-stereo.monitor
Cookie: afb6:5bd8
</code></pre>

<p>如上面所示，此时PulseAudio已经默认使用蓝牙设备作为音频输出，之后便可以播放音频：</p>
<pre><code>aplay exmaple.wmv
</code></pre>

<p>还可以将PulseAudio设置为每次自动切换到新连接的设备上，我们需要在<code>/etc/pulse/default.pa</code>中加入以下配置：</p>
<pre><code># automatically switch to newly-connected devices
load-module module-switch-on-connect
</code></pre>

<h1>问题调试</h1>
<p>蓝牙音频播放如果没有声音，首先第一步确认蓝牙连接已经建立。如果使用PulseAudio，运行<code>pactl list sinks</code>来查看蓝牙设备有没有被识别，运行<code>pactl info</code>来查看蓝牙设备是否是默认的音频输出设备。<code>/var/log/syslog</code>日志文件中也可能会有有用的信息。</p>
<p>当然最重要的还是要理解各个软件包和模块的作用和工作原理，否则还是很难解决可能出现的各种问题。</p>
<p>需要注意的是，上面的方案一和方案二无法同时工作。只能二选一，按照实用性来讲，一般都推荐使用第二种PulseAudio的方法。如果方案一和方案二的软件都同时安装了，则需要设置PulseAudio不使用蓝牙(不加载PulseAudio所有蓝牙相关的模块)，否则将会出现问题。</p>
<h1>树莓派3 Model B 的蓝牙播放抖动杂音问题</h1>
<p>树莓派3 Model B 的板载的蓝牙和Wifi是集成在同一个芯片上的，目前wifi和蓝牙同时工作时会相互影响，尤其是在使用蓝牙播放音频设备时，数据量比较大，开始播放时会出现明显的杂音，之后逐渐消失。目前该问题还没有明确的解决方案。具体信息请见和最新进展请看<a href="https://github.com/raspberrypi/linux/issues/1402">这里</a>。</p>
<p>针对该问题，目前只能通过禁用wifi功能来可以解决：</p>
<pre><code>sudo ifconfig wlan0 down
</code></pre>

<p>使用外接的独立USB无线网卡也可以解决该问题，或者使用以太网网线进行连接。</p>
<h1>参考链接</h1>
<ul>
<li><a href="https://wiki.debian.org/PulseAudio">https://wiki.debian.org/PulseAudio</a></li>
<li><a href="https://gavv.github.io/blog/pulseaudio-under-the-hood/">https://gavv.github.io/blog/pulseaudio-under-the-hood/</a></li>
<li><a href="https://wiki.debian.org/ALSA">https://wiki.debian.org/ALSA</a></li>
<li><a href="http://www.bluez.org/">http://www.bluez.org/</a></li>
<li><a href="https://github.com/Arkq/bluez-alsa">https://github.com/Arkq/bluez-alsa</a></li>
<li><a href="https://wiki.debian.org/Bluetooth/Alsa">https://wiki.debian.org/Bluetooth/Alsa</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Bluetooth_headset">https://wiki.archlinux.org/index.php/Bluetooth_headset</a></li>
<li><a href="https://wiki.archlinux.org/index.php/bluetooth">https://wiki.archlinux.org/index.php/bluetooth</a></li>
</ul>
    <br>
    <strong>Tags: </strong>
      <a href="/tags#RaspberryPi" class="entry_tag"> RaspberryPi </a>
  </div>
    </div>
    <footer>
        <form style="padding:3px;text-align:center;margin:10px auto;" action="https://tinyletter.com/nmhnmh" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/nmhnmh', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"><p><label for="tlemail">Subscribe to my personal newsletter</lable></p></p><label for="tlemail">订阅我的个人邮件列表</label></p><p><input type="email" style="border:1px solid #eee; min-width:140px; padding: 5px 10px;" name="email" id="tlemail" placeholder="your email here"/></p><input type="hidden" value="1" name="embed"/><input type="submit" value="Subscribe/订阅" /><p><a href="https://tinyletter.com" target="_blank">powered by TinyLetter</a></p></form>

        <div>
          <a href="https://twitter.com/niminghao" title="Visit My Twitter"><img style="width: 31px; height: 31px;" src="/assets/images/twitter.png" alt="Twitter"></a>
          <a href="#niminghao804.gmail" title="Send me an email: niminghao804.gmail"><img style="width: 31px; height: 31px;" src="/assets/images/gmail.png" alt="Gmail"></a>
          <a href="https://github.com/nmhnmh" title="See me on Github"><img style="width: 31px; height: 31px;" src="/assets/images/github.png" alt="Github"></a>
          <a href="https://www.linkedin.com/in/nmhnmh/" title="Connect with me on Linkedin"><img style="height: 31px;" src="/assets/images/linkedin.png" alt="Linkedin"></a>
          <a href="/rss.xml" title="Subscribe to RSS Feed"><img style="width: 31px; height: 31px;" src="/assets/images/rss.jpg" alt="RSS"></a>
          <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="Attribution-NonCommercial-ShareAlike 4.0 International"><img style="height: 31px;" src="/assets/images/cc-by-nc-sa.png" alt="CC BY-NC-SA 4.0"></a>
        </div>
        <div style="font-size: 0.6rem">
          If not explicitly specified, contents on this website are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
          <br>
          未单独声明的情况下，本站内容默认采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
        </div>
    </footer>
    <script src='https://cdn.jsdelivr.net/highlight.js/9.11.0/highlight.min.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src='https://cdn.jsdelivr.net/jquery/3.2.1/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/lunr/1.0.0/lunr.min.js'></script>
    <script>
    function initSearch(){
      var index = window.site_index = lunr(function () {
        this.field('title', {boost: 10})
        this.field('tags')
        this.ref('link');
      })
      var store = window.site_index_store = {};
      $.getJSON('/index.json', function(data){
        var len = data.length;
        for(var i=0;i<len;i++){
          index.add(data[i]);
          store[data[i].link] = data[i];
        }
      })
    }
    function display_result(data){
      var panel = $('#q_results');
      var len = data.length;
      if(len>0){
        panel.show();
        var html = "<ul>";
        for(var i=0;i<len && i<20;i++){
          var item = window.site_index_store[data[i].ref];
          html += "<li><a href='"+item.link+"'>"+item.title+"</a></li>"
        }
        html += "</ul>";
        panel.html(html)
      } else {
        panel.hide();
      }
    }
    var search_timer = null;
    $('#q').on('focus', function(e){
      if(!window.site_index)
        initSearch();
    });
    $('#q').on('keyup', function(e){
      var v = $('#q').val().trim();
      // debounce
      clearTimeout(search_timer);
      // clear result when no query provided
      if(!v){
        display_result([]);
        return;
      }
      search_timer = setTimeout(function(query){
        display_result(window.site_index.search(v));
      }, 300, v);
    });
    </script>
    <script>
    document.getElementById('nav_trigger').addEventListener('click', function(e){
      var menu = document.getElementById('nav_menu');
      var styles = window.getComputedStyle(menu, null);
      if(styles.getPropertyValue('display')==='none'){
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    });
    </script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89643442-1', 'auto');
    ga('send', 'pageview');
    </script>
  </body>
</html>
