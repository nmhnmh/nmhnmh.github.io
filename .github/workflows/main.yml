name: build and deploy to github pages

on:
  push:
    branches:
      - source

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: checkout the site source
        uses: actions/checkout@v1

      - name: build the site
        # github actios will set the WORKDIR at runtime, no need to map the volumns manually
        uses: docker://nmhnmh/sitekicker:latest

      - name: deploy to github pages
        run: |
          cd ~
          mkdir .ssh
          echo "${{ secrets.ACTIONS_DEPLOY_KEY }}" >> ~/.ssh/id_rsa
          export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa'
          cd "$GITHUB_WORKSPACE/.build"
          git init
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add .
          git commit -m 'Deploy to GitHub Pages'
          git push --force "git@github.com:${GITHUB_REPOSITORY}.git" master:master
          
